<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Currency Converter</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Select2 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
  <style>
    html {
      scroll-behavior: smooth;
    }
  </style>
  <style>
    .news-carousel-container {
      position: relative;
      overflow: hidden;
      padding: 0 40px;
    }

    .news-carousel {
      display: flex;
      overflow-x: auto;
      scroll-snap-type: x mandatory;
      gap: 20px;
      padding: 10px 0;
      scroll-behavior: smooth;
      scrollbar-width: none; 
    }

    .news-card {
      flex: 0 0 calc(33.333% - 13.33px);
      scroll-snap-align: start;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      height: 280px;
      position: relative;
      transition: transform 0.3s;
      background-color: #f8f9fa;
    }
    .news-carousel::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Edge */
    }

    .news-card:hover {
      transform: scale(1.03);
    }

    .news-img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      display: block;
    }

    .news-title {
      background: rgba(0,0,0,0.6);
      color: #fff;
      width: 100%;
      padding: 10px;
      font-size: 14px;
      font-weight: 500;
      text-align: center;
      text-decoration: none;
      display: block;
    }

    .news-title:hover {
      text-decoration: underline;
    }

    .default-bg {
      width: 100%;
      height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: bold;
      font-size: 16px;
      background: linear-gradient(135deg, rgba(0, 123, 255, 0.5), rgba(0, 123, 255, 0.2));
    }

    .carousel-btn {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background-color: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      padding: 10px;
      z-index: 10;
      cursor: pointer;
      border-radius: 50%;
    }

    .carousel-btn.left {
      left: 0;
      transform: translate(-50%, -50%);
    }

    .carousel-btn.right {
      right: 0;
      transform: translate(50%, -50%);
    }
  </style>
  <style>
    body.dark-mode {
      background-color: #0d1117 !important;  
      color: #c9d1d9;
    }

    .dark-mode .card {
      background-color: #161b22;
      border-color: #30363d;
      color: #c9d1d9;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6);
    }

    .dark-mode .table {
      background-color: #161b22;
      color: #c9d1d9;
    }

    .dark-mode .table thead {
      background-color: #21262d;
      color: #f0f6fc;
    }

    .dark-mode .news-title {
      background: rgba(32, 35, 39, 0.85);
      color: #c9d1d9;
    }

    .dark-mode .news-card {
      background-color: #1c2128;
      box-shadow: 0 3px 8px rgba(255, 255, 255, 0.05);
    }

    .dark-mode .default-bg {
      background: linear-gradient(135deg, rgba(56, 139, 253, 0.4), rgba(32, 39, 60, 0.4));
      color: #f0f6fc;
    }

    .dark-mode .form-control,
    .dark-mode .form-select {
      background-color: #0d1117;
      color: #c9d1d9;
      border: 1px solid #30363d;
    }

    .dark-mode .btn-outline-secondary {
      color: #c9d1d9;
      border-color: #6e7681;
    }

    .dark-mode .alert {
      background-color: #21262d;
      color: #c9d1d9;
      border-color: #30363d;
    }

    .dark-mode .nav-tabs .nav-link {
      color: #8b949e;
    }

    .dark-mode .nav-tabs .nav-link.active {
      background-color: #21262d;
      color: #f0f6fc;
      border-color: #30363d #30363d #0d1117;
    }

    .dark-mode .table-hover tbody tr:hover {
      background-color: #2c313a;
    }

    .dark-mode .form-label {
      color: #b1bac4;
    }

    .dark-mode .select2-container--default .select2-selection--single {
      background-color: #0d1117;
      border: 1px solid #30363d;
      color: #c9d1d9;
    }

    .dark-mode .select2-container--default .select2-selection--single .select2-selection__rendered {
      color: #c9d1d9;
    }

    .dark-mode .select2-container--default .select2-results__option--highlighted {
      background-color: #1f6feb;
      color: #fff;
    }

  </style>


</head>

<body class="bg-light">
  <div class="container py-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1 class="mb-0 d-flex align-items-center gap-3">
        <i class="bi bi-globe2"></i> Currency Converter
        <button id="darkToggle" class="btn btn-sm btn-outline-secondary" title="Toggle Dark Mode">üåô</button>
      </h1>
      <ul class="nav nav-tabs" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link active" id="convert-tab" data-bs-toggle="tab" data-bs-target="#convert" type="button" role="tab">Convert</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="rate-tab" data-bs-toggle="tab" data-bs-target="#rate" type="button" role="tab">Rate Table</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="symbol-tab" data-bs-toggle="tab" data-bs-target="#symbol" type="button" role="tab">Symbol</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button" role="tab">History</button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link" id="about-tab" data-bs-toggle="tab" data-bs-target="#about" type="button" role="tab">About</button>
        </li>
      </ul>
    </div>
    <div class="tab-content" id="myTabContent">
      <!-- Convert Tab -->
      <div class="tab-pane fade show active" id="convert" role="tabpanel" aria-labelledby="convert-tab"> 
        <form method="POST" class="row g-3 ">
          <div class="col-md-3">
            <label class="form-label">From Currency</label>
            <select class="currency-select" name="from_currency" data-placeholder="Select a currency" style="width: 100%;">
              {% for code, info in currencies.items() %}
                <option value="{{ code }}">{{ code }} </option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-3">
            <label class="form-label">To Currency</label>
            <select class="currency-select" name="to_currency" data-placeholder="Select a currency" style="width: 100%;">
              {% for code, info in currencies.items() %}
                <option value="{{ code }}">{{ code }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Amount</label>
            <input type="number" name="amount"  step="0.000001" class="form-control" required>
          </div>

          <div class="col-12 text-center mt-3">
            <button type="submit" class="btn btn-primary">Convert</button>
          </div>
        </form>
            {% if result %}
              <div class="d-flex justify-content-center mt-3">
                <div class="alert alert-success text-center" style="max-width: 600px; width: 100%;">
                  üí± <strong>Result:</strong> {{ request.form.amount }} {{ request.form.from_currency }}
                  = <strong>{{ result.result }} {{ request.form.to_currency }}</strong><br>
                  üìÖ Exchange Rate: {{ result.rate }} on {{ result.date }}
                </div>
              </div>
            {% endif %}
 
    <hr class="my-5">


      <form method="POST" class="row g-3 ">
        <input type="hidden" name="form_type" value="second_convert">  <!-- Identifies which form is submitted -->

        <div class="col-md-3">
          <label class="form-label">From Currency</label>
          <select class="currency-select" name="from_currency" data-placeholder="Select a currency" style="width: 100%;">
            {% for code, info in currencies.items() %}
              <option value="{{ code }}">{{ code }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-3">
          <label class="form-label">To Currency</label>
          <select class="currency-select" name="to_currency" data-placeholder="Select a currency" style="width: 100%;">
            {% for code, info in currencies.items() %}
              <option value="{{ code }}">{{ code }}</option>
            {% endfor %}
          </select>
        </div>
        
          <!-- Split input -->
          <div class="col-md-2">
            <label class="form-label">Amount</label>
            <input type="number" name="split_amount" step="0.000001" class="form-control" required>
          </div>

          <div class="col-md-2">
            <label class="form-label">Unit</label>
            <select name="unit_multiplier" class="form-select">
              <option value="1000">Thousand</option>
              <option value="1000000" selected>Million</option>
              <option value="1000000000">Billion</option>
              <option value="1000000000000">Trillion</option>
            </select>
          </div>

        <div class="col-12 text-center mt-3">
          <button type="submit" class="btn btn-primary">Convert</button>
        </div>
      </form>

      {% if second_result %}
        <div class="d-flex justify-content-center mt-3">
          <div class="alert alert-info text-center" style="max-width: 600px; width: 100%;">
            üí± <strong>Result:</strong> {{ display_amount }} {{ request.form.from_currency }}
            = <strong>{{ second_result.result }} {{ request.form.to_currency }}</strong><br>
            üìÖ Exchange Rate: {{ second_result.rate }} on {{ second_result.date }}
          </div>
        </div>
      {% endif %}
    
      <div class="news-section mt-5">
        <h4 class="mb-3">üì∞ Latest Currency News</h4>
        <div class="news-carousel-container">
          <button class="carousel-btn left" id="prevBtn">‚óÄ</button>
          <div class="news-carousel" id="news-container">
            <!-- News cards will be injected here -->
          </div>
          <button class="carousel-btn right" id="nextBtn">‚ñ∂</button>
        </div>
      </div>

      <script>
        const newsContainer = document.getElementById("news-container");
        let autoScroll;
        const colors = [
          "#cce5ff", "#d4edda", "#fff3cd", "#e2d9f3", "#f8d7da", "#d1ecf1", "#f5c6cb",
          "#f0e68c", "#e6e6fa", "#ffe4e1", "#e0ffff", "#f5f5dc", "#e1f5fe"
        ];

        fetch("/get_news")
          .then(res => res.json())
          .then(data => {
            data.forEach((item, index) => {
              const card = document.createElement("div");
              card.className = "news-card";

              let content = '';
              if (item.image) {
                content = `<img src="${item.image}" class="news-img" alt="News Image">`;
              } else {
                const bgColor = colors[index % colors.length];
                content = `<div class="default-bg" style="background-color: ${bgColor};">No Image</div>`;
              }

              content += `<a href="${item.url}" target="_blank" class="news-title">${item.title}</a>`;
              card.innerHTML = content;
              newsContainer.appendChild(card);
            });
            startAutoScroll();
            newsContainer.addEventListener("mouseenter", stopAutoScroll);
            newsContainer.addEventListener("mouseleave", startAutoScroll);
          })
          .catch(err => {
            const prevBtn = document.getElementById("prevBtn");
            const nextBtn = document.getElementById("nextBtn");
            newsContainer.innerHTML = "<p class='text-danger'>‚ö†Ô∏è Failed to load news.</p>";
          });

        function scrollNews(direction) {
          const cardWidth = newsContainer.querySelector(".news-card")?.offsetWidth || 300;
          newsContainer.scrollBy({ left: direction * (cardWidth + 20), behavior: 'smooth' });
        }
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        prevBtn.addEventListener("click", () => scrollNews(-1));
        nextBtn.addEventListener("click", () => scrollNews(1));

            // Auto scroll enhancement
            function startAutoScroll() {
              stopAutoScroll();
              autoScroll = setInterval(() => {
                if (newsContainer.scrollLeft + newsContainer.clientWidth >= newsContainer.scrollWidth) {
                  newsContainer.scrollTo({ left: 0, behavior: 'smooth' });
                } else {
                  scrollNews(1);
                }
              }, 4000);
            }

            function stopAutoScroll() {
              clearInterval(autoScroll);
            }
          </script>
    </div>

      <!-- Rate Table Tab -->
      <div class="tab-pane fade" id="rate" role="tabpanel" aria-labelledby="rate-tab">
        <!-- Live Exchange Rate Table -->
        <div class="card mt-5">
          <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">üìä Live Exchange Rates</h4>
            <div>
              <label class="form-label mb-0 me-2">Base Currency:</label>
              <select id="base-currency" class="form-select d-inline-block w-auto">
                {% for code, info in currencies.items() %}
                  <option value="{{ code }}" {% if code == 'USD' %}selected{% endif %}>{{ code }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="card-body">
            <!-- Download Buttons -->
<div class="mb-3 d-flex justify-content-end gap-2">
  <button id="downloadPdf" class="btn btn-outline-danger btn-sm"> üñ®Ô∏è Download PDF</button>
</div>

            <div class="table-responsive">
              <table class="table table-striped table-hover" id="rate-table">
                <thead class="table-dark">
                  <tr>
                    <th>Currency</th>
                    <th>Country</th>
                    <th>Flag</th>
                    <th>Rate</th>
                    <th>Change</th>
                  </tr>
                </thead>
                <tbody>
                  <!-- Data will be loaded here via JavaScript -->

                </tbody>
              </table>
            </div>
            <p class="text-muted text-end mt-2" id="last-updated">Last updated: --</p>
            <script>
  async function loadRates(base = "USD") {
    const res = await fetch(`/api/rates/${base}`);
    const data = await res.json();
    console.log(data);

    if (!data.rates || !Array.isArray(data.rates)) {
      alert("Failed to load rates.");
      return;
    }

    const tbody = document.querySelector("#rate-table tbody");
    tbody.innerHTML = "";

    data.rates.forEach(row => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${row.currency}</td>
        <td>${row.country}</td>
        <td><img src="${row.flag}" alt="${row.currency}" width="32"></td>
        <td>${row.rate}</td>
        <td>${row.indicator} ${row.change > 0 ? '+' : (row.change < 0 ? '' : '')}${row.change}</td>
      `;
      tbody.appendChild(tr);
    });

    document.getElementById("last-updated").textContent = "Last updated: " + data.date;
  }

  document.getElementById("base-currency").addEventListener("change", function () {
    loadRates(this.value);
  });

  window.addEventListener("DOMContentLoaded", () => {
    loadRates(document.getElementById("base-currency").value);
  });
</script>

          </div>
        </div>
      </div>

      <!-- Symbol Tab -->
      <div class="tab-pane fade" id="symbol" role="tabpanel" aria-labelledby="symbol-tab">
        <div id="symbol-content" class="mt-4">
          {% include "symbol.html" %}
        </div>
      </div>

      <!-- History Tab -->
      <div class="tab-pane fade" id="history" role="tabpanel" aria-labelledby="history-tab">
        <p class="mt-4">üìú Historical exchange rate comparison view.</p>
      </div>

      <!-- About Tab -->
      <div class="tab-pane fade" id="about" role="tabpanel" aria-labelledby="about-tab">
        <p class="mt-4">‚ÑπÔ∏è This project is built with Flask, Bootstrap, Select2, and live currency API integrations.</p>
      </div>
    </div>
  <!-- Scripts at end -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    $(document).ready(function() {
      $('.currency-select').select2({
        placeholder: 'Select a currency',
        allowClear: true,
        width: '100%',
        dropdownAutoWidth: true 
      });
    });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- jsPDF & AutoTable Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
  document.getElementById("downloadPdf").addEventListener("click", async () => {
      const baseCurrency = document.getElementById("base-currency").value;
      const table = document.getElementById("rate-table");
      const rows = table.querySelector("tbody").rows;

      const meta = await fetch("/data/currency_meta.json").then(res => res.json());
      const baseCurrencyInfo = meta[baseCurrency];
      const baseCountryName  = baseCurrencyInfo ? baseCurrencyInfo.country : "";

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
       
      // ‚úÖ (4) Add branding at top center
      doc.setFontSize(16);
      doc.setFont(undefined, "bold");
      doc.text("Currency Converter", pageWidth / 2, 10, { align: "center" });

      // ‚úÖ (2) Updated intro paragraph (bold + colon)
      doc.setTextColor(33);
      doc.setFontSize(12);
      doc.setFont(undefined, "bold");
      doc.text(`Exchange rates for 1 ${baseCurrency}${baseCountryName   ? " (" + baseCountryName   + ")" : ""} in other currencies: `, 14, 20);

      // ‚úÖ (1) Include only Currency | Country | Rate
      const tableData = [];
      for (let row of rows) {
          const cells = row.cells;
          const currency = cells[0].innerText.trim();
          const country = cells[1].innerText.trim();
          const rate = cells[3].innerText.trim();
          tableData.push([currency, country, rate]);
      }

      doc.autoTable({
          startY: 30,
          head: [["Currency", "Country", "Rate"]],
          body: tableData,
          theme: "striped",
          styles: { fontSize: 10 },
          headStyles: { fillColor: [44, 62, 80] },

          didDrawPage: function (data) {
        const pageWidth = doc.internal.pageSize.getWidth();
        const pageHeight = doc.internal.pageSize.getHeight();

        doc.setFontSize(8);
        doc.setTextColor(150);
        doc.text("CurrencyConverter.com", pageWidth - 50, pageHeight - 10);
          }
      });

      doc.save(`exchange_rates_${baseCurrency}.pdf`);
  });
</script>
<script>
  const toggleBtn = document.getElementById("darkToggle");
  const body = document.body;

  // Load preference
  if (localStorage.getItem("dark-mode") === "enabled") {
    body.classList.add("dark-mode");
    toggleBtn.textContent = "‚òÄÔ∏è";
  }

  toggleBtn.addEventListener("click", () => {
    body.classList.toggle("dark-mode");
    const enabled = body.classList.contains("dark-mode");
    localStorage.setItem("dark-mode", enabled ? "enabled" : "disabled");
    toggleBtn.textContent = enabled ? "‚òÄÔ∏è" : "üåô";
  });
</script>

</body>
</html>
