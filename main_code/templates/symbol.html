<div class="container mt-5">
  <div class="row h-100">
<!-- Left Column: Dropdown + 3D Symbol Box with same width -->
<div class="col-lg-4 col-md-12 mb-4 d-flex flex-column align-items-start">

  <!-- Dropdown Card -->
  <div class="card shadow-sm border-0 mb-3" style="width: 320px;">
    <div class="card-header bg-primary text-white text-center fs-6 fw-semibold">
      üåç Choose a Country
    </div>
    <div class="card-body p-2">
      <select name="currency" id="currency"
              class="form-select form-select-sm w-100">
        <option disabled selected>-- Select a Country --</option>
        {% for code, data in currencies.items() %}
          <option value="{{ code }}">{{ data.country }} ({{ code }})</option>
        {% endfor %}
      </select>
    </div>
  </div>

  <!-- 3D Currency Symbol Box -->
  <div id="symbol-3d-container"
       style="width: 320px; height: 280px;
              background: linear-gradient(135deg, #e0f7fa, #ffffff);
              border-radius: 10px;
              box-shadow: 0 2px 8px rgba(0,0,0,0.1);
              display: flex;
              align-items: center;
              justify-content: center;"> 
    <p class="text-muted fw-semibold fs-6 text-center px-2">üîÑ 2D Currency Symbol Loading...</p>
  </div>
  <button id="download-btn" class="btn btn-outline-primary mt-3" style="width: 320px;">
    üíæ Download Symbol as PNG
  </button>
</div>
    <!-- Right Column: Mini Quiz -->
    <div class="col-lg-8 col-md-12 d-flex flex-column justify-content-between">
      <div class="card shadow-sm border-0 p-2 h-100" id="quiz-card"
           style="background: linear-gradient(135deg, #e0f7fa, #ffffff); border-radius: 10px;">
        <div class="d-flex justify-content-between align-items-center mb-2 position-relative">
          <button class="btn btn-sm btn-outline-primary" onclick="showPreviousQuestion()">
            Previous
          </button>
          <h5 class="fw-bold text-primary position-absolute top-50 start-50 translate-middle text-center m-0">
            üß† Currency Quiz
          </h5>
          <button class="btn btn-sm btn-outline-primary" onclick="showNextQuestion()">
            Next
          </button>
        </div>

        <div id="quiz-container">
          <p>Loading question...</p>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Floating AI Chatbot aligned bottom-right -->
<div id="ai-assistant" style="position: fixed; bottom: 20px; right: 20px; z-index: 9999;">
  <div class="chat-wrapper" style="position: relative;">
    <!-- Chat Toggle Button (just for appearance) -->
    <button class="btn btn-dark rounded-pill shadow-sm ">
      ü§ñ Ask AI CurrencyBot
    </button>

    <!-- Chat Window -->
    <div id="chat-window" class="card shadow" style="
        width: 270px;
        height: 370px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        flex-direction: column;
        position: absolute;
        bottom: 50px;
        right: 0;
        background: #ffffff;
        border-radius: 12px;
        overflow: hidden;
        display: flex; 
      ">
      <!-- Header -->
      <div class="card-header bg-dark text-white p-2 text-center">
        üí¨ CurrencyBot AI
      </div>

      <!-- Messages -->
      <div id="chat-messages" style="
          flex-grow: 1;
          overflow-y: auto;
          padding: 10px;
          font-size: 0.9rem;
        ">
        <div style="
          color: #b71c1c;
          background-color: #ffebee;
          border-left: 5px solid #f44336;
          padding: 12px;
          border-radius: 6px;
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
          font-size: 0.95rem;
          font-weight: 500;
        ">
          ‚ö†Ô∏è <strong>CurrencyBot is temporarily unavailable.</strong><br>
         We're currently upgrading the assistant to serve you better. Please check back soon!
      </div>
      </div>

      <!-- Input -->
      <div class="input-group p-2">
        <input type="text" class="form-control form-control-sm" placeholder="Chat temporarily disabled" disabled />
        <button class="btn btn-sm btn-secondary" disabled>Send</button>
      </div>
    </div>
  </div>
</div>

<!-- üìå Floating 'Important Links' Button -->
<div id="important-links" style="position: fixed; top: 80px; right: 20px; z-index: 9998;">
  <!-- Tooltip -->
  <div id="important-tooltip" style="
    display: none;
    position: absolute;
    right: 50px;
    top: 10px;
    background-color: #343a40;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 0.8rem;
    white-space: nowrap;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  ">
    More important links<br><small>Click to see more links</small>
  </div>

  <!-- Floating Button -->
  <button id="menu-button" class="btn btn-danger rounded-circle shadow"
          style="width: 40px; height: 40px; font-size: 20px;">
    ‚ò∞
  </button>

  <!-- Dropdown Menu -->
  <div id="menu-dropdown" class="card shadow-sm mt-2" style="
      display: none;
      width: 250px;
      position: absolute;
      right: 0;
      background: white;
      border-radius: 8px;
      overflow: hidden;
  ">
    <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" 
       href="https://en.numista.com/" target="_blank">
      <span>ü™ô</span> <span class="link-text">Numista</span>
    </a>
    <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" 
       href="https://www.britishmuseum.org/collection/galleries/coins-and-medals" target="_blank">
      <span>üèõÔ∏è</span> <span class="link-text">British Museum - Coins</span>
    </a>
    <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" 
       href="https://www.ngccoin.com/coin-explorer/" target="_blank">
       <span>üîç</span> <span class="link-text">NGC Coin Explorer</span>
    </a>
    <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" 
       href="http://worldcoingallery.com/" target="_blank">
       <span>üåê</span> <span class="link-text">World Coin Gallery</span>
    </a>
    <a class="list-group-item list-group-item-action d-flex align-items-center gap-2" 
       href="https://www.bis.org/cbanks.htm" target="_blank">
       <span>üè¶</span> <span class="link-text">Central Bank Websites</span>   
    </a>
  </div>
</div>


<!-- ‚úÖ Add hover behavior style for chatbot -->
<script>
  const aiAssistant = document.getElementById("ai-assistant");
  const chatWindow = document.getElementById("chat-window");

  aiAssistant.addEventListener("mouseenter", () => {
    chatWindow.style.opacity = "1";
    chatWindow.style.pointerEvents = "auto";
  });

  aiAssistant.addEventListener("mouseleave", () => {
    chatWindow.style.opacity = "0";
    chatWindow.style.pointerEvents = "none";
  });
</script>

<!-- JS Script to handle 2D symbol display -->
<script>
  const symbolMap = JSON.parse('{{ currency_symbols | tojson | safe }}');
  const countryMap = JSON.parse('{{ currencies | tojson | safe }}');
  const currencyNameMap = JSON.parse('{{ currency_names | tojson | safe }}');


  const dropdown = document.getElementById("currency");
  const symbolBox = document.getElementById("symbol-3d-container");

  dropdown.addEventListener("change", () => {
    const code = dropdown.value;  // e.g., 'INR'
    const symbol = symbolMap[code] || "‚ùì";
    const country = countryMap[code]?.country || "Unknown Country";
    const currencyName = currencyNameMap[code] || `${country} Currency`;

    symbolBox.innerHTML = `
      <div style="
        text-align: center;
        color: #1e88e5;
        font-weight: bold;
      ">
        <div style="font-size: 125px;">${symbol}</div>
        <div style="font-size: 20px;">${country}</div>

        <button onclick="speakCurrency('${currencyName}')" 
                class="btn btn-sm btn-outline-secondary mt-2">
        üîä Pronounce
        </button>
      </div>
    `;
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
  document.getElementById("download-btn").addEventListener("click", () => {
    const symbolContainer = document.getElementById("symbol-3d-container");

    html2canvas(symbolContainer, {
      backgroundColor: null,
      scale: 2
    }).then(canvas => {
      const link = document.createElement("a");
      const code = document.getElementById("currency").value || "symbol";
      link.download = `${code}_symbol.png`;
      link.href = canvas.toDataURL("image/png");
      link.click();
    });
  });
</script>

<script>
  function speakCurrency(text) {
    if ('speechSynthesis' in window) {
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'en-US';
      window.speechSynthesis.speak(msg);
    } else {
      alert("Sorry, your browser doesn't support speech synthesis.");
    }
  }
</script>

<script>
  let quizData = [];
  let questionHistory = [];
  let userAnswers = {};
  let currentQuestionIndex = null;
  let historyPosition = -1;

  async function loadQuizData() {
    try {
      const res = await fetch('/get_quiz');
      const data = await res.json();
      quizData = data.questions;
      showNextQuestion();  
    } catch (err) {
      document.getElementById('quiz-container').innerHTML = "<p class='text-danger'>Failed to load quiz.</p>";
    }
  }

  function showQuestionByIndex(index, isBack = false) {
    const container = document.getElementById('quiz-container');
    const q = quizData[index];
    currentQuestionIndex = index;

    const existingPos = questionHistory.indexOf(index);
    if (existingPos !== -1) {
      historyPosition = existingPos;
    } else {
      if (!isBack) {
        // Truncate forward history and push this new question
        questionHistory = questionHistory.slice(0, historyPosition + 1);
        questionHistory.push(index);
        historyPosition = questionHistory.length - 1;
      }
    }

    const imageHtml = q.image ? `<img src="${q.image}" alt="Quiz Image" class="img-fluid rounded shadow-sm mb-3" style="max-height: 200px;">` : '';

    const quizHtml = `
      <p class="fw-semibold">${q.question}</p>
      ${imageHtml}
      <form id="quiz-form">
        ${q.options.map((opt, i) => `
          <div class="form-check">
            <input class="form-check-input" type="radio" name="quiz-option" value="${opt}" id="opt${i}">
            <label class="form-check-label" for="opt${i}">${opt}</label>
          </div>
        `).join('')}
      </form>
      <div id="quiz-feedback" class="mt-3"></div>
    `;


    container.innerHTML = quizHtml;

    // Answer/Feedback logic
    const radioButtons = document.querySelectorAll('input[name="quiz-option"]');
    radioButtons.forEach((radio) => {
      radio.addEventListener('change', function () {
        const selected = document.querySelector('input[name="quiz-option"]:checked');
        const feedback = document.getElementById('quiz-feedback');

        if (!selected) return;

        userAnswers[index] = selected.value;

        radioButtons.forEach(inp => inp.disabled = true);
        document.querySelectorAll('.form-check-label').forEach(label => {
          label.innerHTML = label.innerHTML.replace(/‚úÖ|‚ùå/g, '').trim();
        });

        const selectedLabel = selected.nextElementSibling;

        if (selected.value === q.answer) {
          selectedLabel.innerHTML += ' <span class="quiz-mark correct-mark">‚úÖ</span>';
          feedback.innerHTML = `<div class="text-success fw-semibold">${q.explanation}</div>`;
        } else {
          selectedLabel.innerHTML += ' <span class="quiz-mark incorrect-mark">‚ùå</span>';
          radioButtons.forEach(inp => {
            if (inp.value === q.answer) {
              inp.nextElementSibling.innerHTML += ' <span class="quiz-mark correct-mark">‚úÖ</span>';
            }
          });
          feedback.innerHTML = `
            <div class="text-danger fw-semibold">Correct answer: ${q.answer}</div>
            <div class="text-secondary">${q.explanation}</div>
          `;
        }
      });
    });

    const previouslySelected = userAnswers[index];
    if (previouslySelected) {
      const inputToCheck = document.querySelector(`input[value="${previouslySelected}"]`);
      if (inputToCheck) {
        inputToCheck.checked = true;
        inputToCheck.dispatchEvent(new Event('change')); // Triggers feedback
      }
    }

  }

  function showNextQuestion() {
    if (historyPosition < questionHistory.length - 1) {
       historyPosition += 1;  
      const nextIndex = questionHistory[historyPosition];
      showQuestionByIndex(nextIndex);
      return;
    }

    
    const unansweredIndexes = quizData.map((_, i) => i).filter(i => !questionHistory.includes(i));

    if (unansweredIndexes.length === 0) {
      alert("üéâ You've completed all quiz questions!");
      return;
    }

    const randomIndex = unansweredIndexes[Math.floor(Math.random() * unansweredIndexes.length)];
    showQuestionByIndex(randomIndex);
  }

  function showPreviousQuestion() {
    if (historyPosition > 0) {
      const prevIndex = questionHistory[historyPosition - 1];
      historyPosition -= 1;
      showQuestionByIndex(prevIndex, true);
    } else {
      alert("No previous question available.");
    }
  }

  window.addEventListener('DOMContentLoaded', loadQuizData);
</script>


<style>
  .quiz-mark {
    font-size: 0.9em;
    vertical-align: middle;
    margin-left: 4px;
  }

  .correct-mark {
    color: green;
  }

  .incorrect-mark {
    color: red;
  }

  #quiz-container p,
  #quiz-container .form-check-label,
  #quiz-feedback {
    font-size: 1.15rem;
  }
  #quiz-card {
    min-height: 400px;
  }
  #quiz-container img {
  display: block;
  margin: 0 auto 1rem auto;
  max-width: 100%;
  height: auto;
  border-radius: 10px;
  object-fit: contain;
}
</style>


<script>
  const menuBtn = document.getElementById("menu-button");
  const menuDropdown = document.getElementById("menu-dropdown");
  const tooltip = document.getElementById("important-tooltip");

  let isMenuVisible = false;

  menuBtn.addEventListener("click", () => {
    isMenuVisible = !isMenuVisible;
    menuDropdown.style.display = isMenuVisible ? "block" : "none";
  });

  menuBtn.addEventListener("mouseenter", () => {
    tooltip.style.display = "block";
  });

  menuBtn.addEventListener("mouseleave", () => {
    tooltip.style.display = "none";
  });

  // Optional: Click outside to close the menu
  window.addEventListener("click", function(e) {
    if (!document.getElementById("important-links").contains(e.target) && isMenuVisible) {
      menuDropdown.style.display = "none";
      isMenuVisible = false;
    }
  });
</script>

<style>
  #menu-button {
    width: 42px;
    height: 42px;
    font-size: 20px;
    border-radius: 50%;
    background-color: #0d6efd !important;
    color: white !important;
    border: none;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #menu-dropdown  {
    background: linear-gradient(135deg, #e0f7fa, #ffffff) !important;
    border-radius: 10px;
    border: none;
  }

  #menu-dropdown a {
    color: #0d6efd !important;
    padding: 10px 16px;
    font-weight: 500;
    border-bottom: 1px solid #cfe8f5; 
    transition: all 0.3s ease;
    background: transparent;
  }

  #menu-dropdown a:hover .link-text  {
    text-decoration: underline;
    text-decoration-color: black;
    background: rgba(255, 255, 255, 0.3);
  }

  #menu-dropdown a:last-child {
    border-bottom: none;
  }
  #important-links {
    position: fixed;
    top: 144px; 
    right: 20px;
    z-index: 9998;
  }
</style>

